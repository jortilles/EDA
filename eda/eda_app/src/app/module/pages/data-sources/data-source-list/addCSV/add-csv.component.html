<eda-dialog2 [display]="display" [header]="title" width="80vw" height="80vh"
  [disableApply]="!tableName || !delimiter || !csvHeaders" (apply)="generateTable()"
  (close)="closeDialog()">

  <div content class="flex flex-grow gap-4 p-2">
    <!-- SecciÃ³n del formulario -->
    <div class="w-full md:w-2/5 mt-4 space-y-4">
      <div class="w-full">
        <label i18n="@@placeholderTableName" for="tablename" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la tabla</label>
        <input
          id="tablename"
          type="text"
          [(ngModel)]="tableName"
          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring focus:ring-blue-200"
        />
      </div>

      <div class="w-full">
        <label i18n="@@placeholderInputSeparator" for="separator" class="block text-sm font-medium text-gray-700 mb-1">Separador</label>
        <input
          id="separator" type="text" placeholder="Separador del modelo" [(ngModel)]="delimiter"
          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring focus:ring-blue-200"
          (keyup)="retryCsvWithNewSeparator()" 
        />
      </div>

      <!-- Drag & Drop CSV -->
            <div (dragenter)="handleDragIn($event, 'csv')" (dragleave)="handleDragOut($event, 'csv')"
              (dragover)="handleDrag($event)" (drop)="handleDrop($event, 'csv')"
              class="relative mt-2 flex h-32 cursor-pointer flex-col items-center justify-center rounded-lg border-2 border-dashed transition-colors"
              [class.border-[#00BFB3]]="isDraggingCsvFile() && delimiter"
              [class.bg-[#00BFB3]]="isDraggingCsvFile() && delimiter"
              [class.border-gray-300]="!isDraggingCsvFile() || !delimiter"
              [class.hover:border-[#00BFB3]]="delimiter && !isDraggingCsvFile()">
              <input type="file" #file (change)="handleFileSelect($event, 'csv'); onFilesAdded()"
                class="absolute inset-0 z-50 h-full w-full cursor-pointer opacity-0"
                accept=".csv" />

              <div class="flex flex-col items-center justify-center text-sm">
                <div *ngIf="_csvFileName(); else noFile">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="mb-2 h-6 w-6 text-[#00BFB3]">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                  <p class="text-sm font-medium">{{ _csvFileName() }}</p>
                </div>
                <ng-template #noFile>
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="mb-2 h-6 w-6 text-gray-400">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                  </svg>
                  <p class="mb-1 font-medium text-gray-600">
                    <span class="text-[#00BFB3]">Click para subir</span> o arrastra y suelta
                  </p>
                  <p class="text-xs text-gray-500">CSV (max. 10MB)</p>
                </ng-template>
              </div>
            </div>

    </div>

    <div class="pt-6 overflow-y-auto w-full h-[65vh]">
            <table class="w-full">
              <!-- header -->
              <thead class="bg-gray-100">
                <tr>
                  @for(header of editFieldsHeaders; track $index){
                  <th class="p-3"> {{ header }} </th>
                  }
                </tr>
              </thead>

              <tbody>
                @for(row of csvColumns; track $index){
                <tr>
                  <!-- Campo -->
                  <td class="p-3">{{ row.field }}</td>

                  <!-- Tipo -->
                  <td class="p-3">
                    <select class="border rounded p-2 w-full" [(ngModel)]="row.type"
                      [ngModelOptions]="{standalone: true}">
                      @for(dt of dataTypes; track $index){
                      <option [value]="dt.value || dt"> {{ dt.label || dt }} </option>
                      }
                    </select>
                  </td>

                  <!-- Formato si es timestamp -->
                  @if(row.type === 'timestamp'){
                  <td class="p-3">
                    <select class="border rounded p-2 w-full" [(ngModel)]="row.format"
                      [ngModelOptions]="{standalone: true}">
                      @for(df of dataFormats; track $index){
                      <option [value]="df.value || df"> {{ df.label || df }} </option>
                      }
                    </select>
                  </td>
                  }

                  <!-- Separador decimal para integer o numeric -->
                  @if(['integer', 'numeric'].includes(row.type)){
                  <td></td>
                  <td class="p-3">
                    <select class="border rounded p-2 w-full" [(ngModel)]="row.separator"
                      [ngModelOptions]="{standalone: true}">
                      @for(sep of decSeparators; track $index){
                      <option [value]="sep.value || sep"> {{ sep.label || sep }} </option>
                      }
                    </select>
                  </td>
                  }
                </tr>
                }
              </tbody>
            </table>
          </div>
  </div>

</eda-dialog2>