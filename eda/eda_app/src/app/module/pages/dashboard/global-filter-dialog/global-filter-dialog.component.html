<eda-dialog2 [display]="display" [header]="dialogHeader" width="60vw" height="80vh" (apply)="onApply()"
    (close)="onClose()">

    <div content>
      <!-- Filter Details -->
      <div class="border rounded-lg shadow-sm">
        <div class="p-4 space-y-4">
          @if (globalFilter?.selectedTable?.table_name && globalFilter?.selectedColumn) {
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-medium">
                {{globalFilter.selectedTable?.display_name?.default}} - {{globalFilter.selectedColumn?.display_name?.default}}
              </h3>
            </div>
          }
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex items-center justify-between space-x-2">
              <div class="flex flex-col space-y-2">
                <label class="font-medium" i18n="@@aplyToAllPanelsH5">¿Aplica a todos los paneles?</label>
                <button 
                  type="button" 
                  role="switch" 
                  [attr.aria-checked]="applyToAll"
                  (click)="applyToAllCheck()"
                  class="peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50" 
                  [ngClass]="{'bg-[#00BFB3]': applyToAll, 'bg-input': !applyToAll}"
                >
                  <span 
                    class="pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform" 
                    [ngClass]="{'translate-x-5': applyToAll, 'translate-x-0': !applyToAll}"
                  ></span>
                </button>
              </div>
            </div>
            
            <div class="flex flex-col space-y-1.5">
              <label class="text-sm font-medium">{{header4}}</label>
              <div class="relative">
                <p-dropdown
                  [options]="publicRoHidden" [(ngModel)]="globalFilter.visible"
                  i18n-title="@@filterVisibleScope"
                  title="Definir la visibilidad del filtro. Públi'Los filtros deben ser del mismo tipaje!'co: todos pueden usarlo.  Deshabilitado: El resto de usuarios pueden ver el filtro pero no pueden modificarlo.  Oculto: El resto de usuarios no pueden ver el filtro, pero se les aplica"
                  [style]="{'width': '100%'}" selected="publicRoHiddenOption"
                ></p-dropdown>
              </div>
            </div>
          </div>
        </div>
      </div>

        <!-- <div class="w-full "> -->
      @if (formReady && !globalFilter.isdeleted) {
        <div class="border rounded-lg shadow-sm mt-4">
          <div class="p-4 space-y-4">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-medium">{{header3}}</h3>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
              <p-dropdown [options]="tables" [style]="{'width': '100%'}"
                [(ngModel)]="globalFilter.selectedTable" filter="true"
                i18n-placeholder="@@placeholderTables" placeholder="Entidades"
                (onChange)="onChangeSelectedTable()" appendTo="body">
                <ng-template pTemplate="selectedItem" let-selectedOption>
                    <div>{{ selectedOption?.display_name?.default }}</div>
                </ng-template>
                <ng-template let-table pTemplate="item">
                    <div>{{ table?.display_name?.default }}</div>
                </ng-template>
              </p-dropdown>
  
              <p-dropdown [options]="columns" [style]="{'width': '100%'}"
                [(ngModel)]="globalFilter.selectedColumn" filter="true"
                i18n-placeholder="@@placeholderColumns" placeholder="Atributos"
                (onChange)="onChangeSelectedColumn()" appendTo="body">
                <ng-template pTemplate="selectedItem" let-selectedOption>
                    <div>{{ selectedOption?.display_name?.default }}</div>
                </ng-template>
                <ng-template let-column pTemplate="item">
                    <div>{{ column?.display_name?.default }}</div>
                </ng-template>
              </p-dropdown>

              <input class="h-8 w-full rounded-md border px-2 py-4"
                [(ngModel)]="aliasValue"
                i18n-placeholder="@@aliasValuePh"
                placeholder="Alias del filtro (opcional)"
              />

              <!-- TODO Show Alias -->
              <!-- <div class="flex">
                <button type="button"
                  (click)="toggleShowAlias()"
                  class="rounded-full p-2.5 m-2 ring-0 cursor-pointer">
                  @if (showAlias) {
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                  } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                  }
                </button>
                @if (showAlias) {
                  <input class="h-8 w-full rounded-md border px-2 py-4"
                    [(ngModel)]="aliasValue"
                    i18n-placeholder="@@aliasValuePh"
                    placeholder="Alias del filtro (opcional)"
                  />
                }
              </div> -->

              @if (globalFilter.selectedColumn?.column_type !== 'date') {
                <p-multiSelect id="selectFilterValue" class='eda-filter-multiselect'
                  [options]="columnValues" [(ngModel)]="globalFilter.selectedItems"
                  [virtualScroll]="true" [itemSize]="30"
                  [style]="{ width: '100%' }"
                  [panelStyle]="{minWidth:'15em'}" [maxSelectedLabels]="1" defaultLabel="Valor por defecto"
                  display="chip" appendTo="body">
                </p-multiSelect>
              }
              @if (globalFilter.selectedColumn?.column_type === 'date') {
                <eda-date-picker #myCalendar
                  [inject]="datePickerConfigs[globalFilter?.id]"
                  [autoClear]="true" (onDatesChanges)="processPickerEvent($event)">
                </eda-date-picker>
              }
            </div>
          </div>
        </div>
      }

        <!-- <p-card *ngIf="formReady && !globalFilter.isdeleted" [header]="header4" id="anywhereClick">
          <p-dropdown id="applyToOneFilterDropdown" i18n-title="@@filterVisibleScope"
            title="Definir la visibilidad del filtro. Público: todos pueden usarlo.  Deshabilitado: El resto de usuarios pueden ver el filtro pero no pueden modificarlo.  Oculto: El resto de usuarios no pueden ver el filtro, pero se les aplica"
            [options]="publicRoHidden" [(ngModel)]="globalFilter.visible"
            [style]="{'width': '100%'}" selected="publicRoHiddenOption" autoWidth="false">
          </p-dropdown>
        </p-card> -->
        <!-- </div> -->

      <!-- Panel Selection -->
      @if (formReady && !globalFilter.isdeleted) {
        @if (globalFilter.queryMode == 'EDA') {
          @if (!applyToAll) {
            <div class="border rounded-lg shadow-sm mt-4">
              <div class="p-4 space-y-4">
                <h3 class="text-lg font-medium">{{header2}}</h3>
                
                <div class="w-full"> 
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                      @for (panel of allPanels; track panel.id) {
                        <span
                          [pTooltip]="isPanelReadOnly(panel) ? 'Panel importado de otro dashboard. Ajusta la configuración desde el mapeador de filtros.' : null"
                          tooltipPosition="top"
                        >
                          <button
                            (click)="togglePanel(panel)"
                            class="flex items-center justify-start w-full h-auto py-2 px-3 rounded-md font-medium transition-colors"
                            [ngClass]="{
                              'bg-gray-200 text-gray-600 cursor-not-allowed': isPanelReadOnly(panel),
                              'bg-[#00BFB3] text-white': isPanelSelected(panel)
                            }"
                            [class.border]="!isPanelSelected(panel)"
                            [class.border-gray-300]="!isPanelSelected(panel)"
                            [disabled]="isPanelReadOnly(panel)"
                          >
                            @if (isPanelSelected(panel.id)) {
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4 shrink-0">
                                <polyline points="20 6 9 17 4 12"/>
                              </svg>
                            }
                            <span class="truncate">{{ panel.title }}</span>
                          </button>
                      </span>
                      }
                    </div>
                </div>
              </div>
            </div>
          }
        } @else if (globalFilter.queryMode == 'EDA2') {
          @if (!isEmpty(globalFilter.selectedTable) && !isEmpty(globalFilter.selectedColumn)) {
            <div class="border rounded-lg shadow-sm mt-4">
              <div class="p-4 space-y-4">
                <h3 class="text-lg font-medium">{{header2}}</h3>
                
                <div class="w-full">
                  <p-table [value]="allPanels">
                    <ng-template pTemplate="header">
                      <tr>
                        <th style="width: 40%;">Panel</th>
                        <th style="width: 60%;">Ruta del filtro</th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-panel>
                      <tr>
                        <td style="width: 40%;">
                          <button type="button" pButton class="ui-button" [label]="panel.title"
                            [style]="{'width': '70%'}" (click)="onAddPanelForFilter(panel)"
                            [ngClass]="{'ui-button-selected': panel.active, 'ui-button-unselected':!panel.active, 'ui-button-unvaliable':!panel.avaliable}">
                          </button>
                        </td>
                          <td style="width: 60%;">
                            <p-treeSelect *ngIf="globalFilter.pathList[panel.id]" 
                              [(ngModel)]="globalFilter.pathList[panel.id].selectedTableNodes"
                              [options]="panel.content.globalFilterPaths"
                              (onNodeExpand)="onNodeExpand(panel, $event)"
                              (onNodeSelect)="onNodeSelect(panel, $event)" appendTo="body"
                              [disabled]="!panel.active || !panel.avaliable">
    
                              <ng-template pTemplate="value">
                                <span class="d-flex align-items-center" [innerHTML]="getDisplayPathStr(globalFilter.pathList[panel.id].selectedTableNodes)"></span>
                              </ng-template>
    
                              <ng-template let-node pTemplate="child">
                                <span [ngClass]="checkNodeSelected(globalFilter.pathList[panel.id].selectedTableNodes, node) ? 'font-weight-bold' : ''"> {{node.label}} </span>
                              </ng-template>
    
                              <ng-template let-node pTemplate="default">
                                <b>{{node.label}}</b>
                              </ng-template>
                            </p-treeSelect>
                          </td>
                      </tr>
                    </ng-template>
                  </p-table>
    
                  <div class="row">
                      <div class="col-12">
                          <span style="margin: 0.5rem;" class="dotgreen"></span>
                          <span style="margin-right: 2rem;">{{greendot}}</span>
    
                          <span style="margin: 0.5rem;" class="dotred"></span>
                          <span style="margin-right: 2rem;">{{reddot}}</span>
    
                          <span style="margin: 0.5rem;" class="dotunselected"></span>
                          <span style="margin-right: 2rem;">{{unselecteddot}}</span>
                      </div>
                  </div>
                </div>
              </div>
            </div>
          }
        }
      }

        <div class="row mt-4">
            <div class="col-12">
                <p-card *ngIf="formReady" [header]="posicion">
                    <div cdkDropList cdkDropListOrientation="horizontal" class="select-list"
                        [cdkDropListData]="globalFilterList" (cdkDropListDropped)="onReorderFilter($event)">
                        <ng-container *ngFor="let filter of globalFilterList">
                            <div *ngIf="!filter.isdeleted" class="select-box col-3 col-md-2 p-1" cdkDrag>
                                <span class="close-thin pointer" (click)="removeFilter(filter)"></span>
                                <!-- [ngClass]="(selectedFilter.table==filter.table) && (selectedFilter.column.label==filter.column.label)?'edaEmfasis':''" -->
                                <span class="text-center">
                                    {{getFilterLabel(filter)}}
                                </span>
                            </div>
                        </ng-container>
                    </div>
                </p-card>
            </div>
        </div>
    </div>
</eda-dialog2>