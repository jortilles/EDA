<eda-dialog2 
[display]="displayWindow" [header]="title" width="80vw" height="70vh" [overflow]="'auto'"
  (apply)="onApply()" (close)="closeDialog()" [showDuplicate]=true (duplicate)="onDuplicate()">
  <!-- class="flex-1 px-6 overflow-y-auto" -->
  <div content class="p-2 space-y-6">
    <div class="grid gap-4"
      [ngClass]="{
        'grid-cols-[0.75fr_0.75fr_0.75fr_3.75fr]': showFormatDateSection,
        'grid-cols-[1fr_1fr_4fr]': !showFormatDateSection}
      ">
      <!-- Agregaciones -->
      <div class="">
        <h4 i18n="@@agregacionesH4">Agregaciones</h4>
        <div class="aggregation-list mt-10">
          @for (aggregation of aggregationsTypes; track aggregation) {
            <div class="aggregation-box"
                (click)="addAggregation(aggregation)"
                [ngClass]="aggregation.selected === true ? 'aggregation-active' : ''">
                <span>{{getAggName(aggregation.value)}}</span>
            </div>
          }
        </div>
      </div>

      <!-- Ordernacion -->
      <div class="">
        <h4 i18n="@@ordenacionH4">Ordenación</h4>
        <div class="aggregation-list mt-10">
          @for (ordenation of ordenationTypes; track ordenation) {
            <div class="aggregation-box"
              (click)="addOrdenation(ordenation)"
              [ngClass]="ordenation.selected === true ? 'aggregation-active' : ''">
              <span>{{ordenation.display_name | uppercase}}</span>
            </div>
          }
        </div>
      </div>

      <!-- FormatDate -->
      @if (showFormatDateSection) {
        <div class="">
          <h4 i18n="@@dateFormatH4">Format</h4>
          <div class="aggregation-list mt-10 w-full">
            <div style="width: 100%;">
              <p-dropdown
              [style]="{width:'100%'}"
                [(ngModel)]="formatDate"
                [options]="formatDates"
                [optionLabel]="'display_name'"
                [autoDisplayFirst]="false"
                [showClear]="true"
                (onChange)="addFormatDate()"
                appendTo="body"
                styleClass="w-full">
              </p-dropdown>
            </div>
          </div>

          <div class="mt-5 ml-4" [pTooltip]="cumulativeSumTooltip" tooltipPosition="left">
            <h6 i18n="@@cumulativeSum">Suma acumulativa</h6>
            <p-inputSwitch
              id="cumulativeSum"
              [(ngModel)]="cumulativeSum"
              (onChange)="handleCumulativeSum()"
              [disabled]="!cumulativeSumAllowed()">
            </p-inputSwitch>
          </div>
        </div>
      }
      <div>
        <h4 i18n="@@filtrarH4">Filtrar</h4>
        <div class="grid grid-cols-[42.5%,42.5%,15%] gap-4 items-start mt-10">
          <div class="flex flex-col gap-4 w-[100%]">
            <!-- Tipo de filtro  -->
            <div>
              <span class="p-float-label ">
                <p-dropdown id="types" [options]="filter.types" [(ngModel)]="filterSelected" optionLabel="label"
                  [autoDisplayFirst]="false" [style]="{'width': '100%'}" [showClear]="true"
                  (onChange)="handleFilterChange(filterSelected)">
                </p-dropdown>
                <label i18n="@@tiposFiltrosLabel" for="types">Tipos de filtro</label>
              </span>
            </div>
            <!-- Switch y botón -->
            <div class="flex justify-between items-center w-full mt-4 w-[100%]">
              <div class="flex items-center gap-2">
                <label i18n="@@optionsLabel" for="filter_options">Opciones</label>
                <br>
                <p-inputSwitch id="filter_options" [(ngModel)]="filter.switch" [disabled]="display.switchButton"
                  (onChange)="loadDropDrownData()">
                </p-inputSwitch>
              </div>
  
  
            </div>
          </div>
  
          <!-- Valores de los filtros -->
          <div class="flex flex-col gap-2">
            @if (!!display.calendar) {
            <eda-date-picker #myCalendar class="h-[3.2rem]" (onDatesChanges)="processPickerEvent($event)"></eda-date-picker>
            }
            @if (!display.calendar && !filter.switch) {
            <span class="p-float-label h-[3.2rem] w-full">
              <input
                id="float-input1"
                class="w-full h-full rounded-md border border-gray-300 px-3 py-2"
                [type]="inputType"
                [(ngModel)]="filterValue.value1"
                (input)="handleValidForm({ value1: filterValue.value1 })"
                pInputText
              />
              @if(!showFormatDateSection){
                <label i18n="@@valor1Label">Valor 1</label>
              }
            </span>
         
            }
            @if (filter.switch) {
            <span class="p-float-label h-[3.2rem] [&_.p-multiselect-label-container]:h-[3.05rem] [&_.p-multiselect-label-container]:flex [&_.p-multiselect-label-container]:items-center">
              <p-multiSelect
                [options]="dropDownFields"
                [(ngModel)]="filterValue.value1"
                [virtualScroll]="true"
                [itemSize]="34"
                [filter]="false"
                [style]="{width:'100%'}"
                [panelStyle]="{minWidth:'100%'}"
                (onChange)="handleValidForm({value1: filterValue.value1})"
                i18n-defaultLabel="@@groupSelect"
                defaultLabel="Selecciona..."
                [loading]="loading"
                [selectionLimit]="limitSelectionFields"
                id="float-input1">
              </p-multiSelect>
              @if(!showFormatDateSection){
                <label i18n="@@valor1Label">Valor 1</label>
              }            </span>
            }
            <!-- Segundo valor por si el filtro es between  -->
            @if (!!display.between) {
            @if (!display.calendar && !filter.switch) {
            <span class="p-float-label h-[3.2rem] [&_.p-multiselect-label-container]:h-[3.05rem] [&_.p-multiselect-label-container]:flex [&_.p-multiselect-label-container]:items-center">
              <input id="float-input2" class="h-[3.2rem] w-full rounded-md border px-2 py-4" [type]="inputType"
                [(ngModel)]="filterValue.value2" (input)="handleValidForm({value2: filterValue.value2})" pInputText>
              <label i18n="@@valor2Label">Valor 2</label>
            </span>
            }
            @if (filter.switch) {
            <span class="p-float-label h-[3.2rem] [&_.p-multiselect-label-container]:h-[3.05rem] [&_.p-multiselect-label-container]:flex [&_.p-multiselect-label-container]:items-center">
              <p-multiSelect [options]="dropDownFields" [(ngModel)]="filterValue.value2" [virtualScroll]="true" [itemSize]="34"
                [filter]="false" [style]="{width:'100%'}" [panelStyle]="{minWidth:'100%'}"
                (onChange)="handleValidForm({value2: filterValue.value2})" i18n-defaultLabel="@@groupSelect" defaultLabel="Selecciona..."
                [selectionLimit]="limitSelectionFields" id="float-input2">
              </p-multiSelect>
              <label i18n="@@valor2Label">Valor 2</label>
            </span>
            }
            }
          </div>

          <div class="flex flex-col gap-2 items-start ">

            <button class="addFilter-button" (click)="addFilter()" [disabled]="display.filterButton">
              <i class="fa fa-plus mr-2"></i>
              <span i18n="@@addFilterBtn">Añadir filtro</span>
            </button>

          </div>
        </div>
        <!-- Filter List -->
        @if (filter.forDisplay.length > 0) {
          <div class="mt-6">
            <h5 i18n="@@filters">Filtros</h5>
            <div class="w-full h-[23vh] mt-2 foot-card bg-gray-100 border-solid border-2 rounded-md">
              <p-scrollPanel styleClass="custombar1">
                @for (filtre of filter.forDisplay; track filtre) {
                  @if (filtre.filter_elements.length === 0) {
                  <p class="flex items-center">
                    <b class="m-1">
                      * {{ selectedColumn.display_name.default }} is
                      {{ filtre.filter_type }}
                    </b>
                    <i class="pi pi-times pointer" (click)="removeFilter(filtre)"></i>
                  </p>
                  }
    
                  @if (filtre.filter_elements.length === 1) {
                  <p class="flex items-center">
                    <b class="m-1">
                      * {{ selectedColumn.display_name.default }}
                      {{ filtre.filter_type }}
                      "{{ filtre.filter_elements[0].value1 }}"
                    </b>
                    <i class="pi pi-times pointer" (click)="removeFilter(filtre)"></i>
                  </p>
                  }
    
                  @if (filtre.filter_elements.length === 2) {
                  <p class="flex items-center">
                    <b class="m-1">
                      * {{ selectedColumn.display_name.default }}
                      {{ filtre.filter_type }}
                      "{{ filtre.filter_elements[0].value1}}" Y "{{ filtre.filter_elements[1].value2 }}"
                    </b>
                    <i class="pi pi-times pointer" (click)="removeFilter(filtre)"></i>
                  </p>
                  }
                }
              </p-scrollPanel>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
</eda-dialog2>

@if(display.duplicateColumn){
  <eda-dialog2 header="Duplicar columna" width="60vw" height= "auto" (close)="onCancelDuplicateColumn()" (apply)="saveDuplicatedColumn()">
    <div content class="p-2 space-y-6">
      <!-- Duplicar columna -->
      <div class="col-12">
        <span>
          <label i18n="@@duplicatedColumnNameLabel" for="duplicatedColumnName" class="text-lg mr-6">
            Nombre columna duplicada
          </label>
          <input pInputText id="duplicatedColumnName" [(ngModel)]="duplicatedColumnName" type="text"  />
        </span>
      </div>
    </div>
  </eda-dialog2>
}