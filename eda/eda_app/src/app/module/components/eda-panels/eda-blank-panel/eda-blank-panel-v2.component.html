
<div class="flex flex-col h-full rounded-lg p-6 shadow-sm bg-white">
  <!-- Header -->
  <div class="flex justify-between items-center mb-2">
    <h2 class="text-lg font-medium"> {{ panel.title || title }}</h2>
    <i class="pi pi-ellipsis-v cursor-pointer" (click)="contextMenu.showContextMenu($event)"></i>
    <!-- <p-button icon="pi pi-ellipsis-v" styleClass="p-button-text" (click)="contextMenu.showContextMenu($event)"></p-button> -->
  </div>

    <div
      class="flex items-center justify-center flex-grow overflow-y-auto rounded-lg bg-gray-50 border border-dashed border-gray-300"
      [class.spinner-panel]="display_v.minispinner">
        @if (display_v.saved_panel && !display_v.minispinner) {
          <div class="relative w-full h-full">
            <panel-chart #PanelChartComponent
              [props]="panelChartConfig"
              (configUpdated)="setChartProperties($event)"
              (onChartClick)="onChartClick($event)"
              class="h-full w-full block">
            </panel-chart>
          </div>
        }

        @if (display_v.minispinner) {
          <div class="grid">
            <div class="col-12">
              <p-progressSpinner [style]="{width: '5vw', height: '5vh'}" strokeWidth="8" class="" fill="#EEEEEE" animationDuration=".5s"></p-progressSpinner>
            </div>
          </div>
        }
    </div>
</div>

<eda-dialog2 *ngIf="display_v.page_dialog" [display]="display_v.page_dialog" width="98vw" height="100vh">
  <!-- Header -->
  <div header class="w-full flex items-center justify-between border-b px-4 py-2">
    <div class="p-2" (click)="titleClick=true;">
      @if (!titleClick) {
        <h1 class="text-lg font-semibold cursor-pointer">
          {{panel.title.trim().length > 0 ? panel.title : '\uD83D\uDD89'}}
        </h1>
      } @else {
        <input type="text" [(ngModel)]="panel.title" autofocusOnShow (focusout)="titleClick=false;"
          class="w-full px-3 py-2 bg-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-[#00bcd4]">
      }
    </div>
    <p-dropdown [(ngModel)]="selectedQueryMode" [options]="queryModes" (onChange)="changeQueryMode()"></p-dropdown>
  </div>
  <!-- Main Content -->
  <div content class="flex h-full w-full flex-col rounded-lg bg-background">
    <div class="flex-1 h-[calc(100%+56px)]">
      <!-- Tabs -->
      <p-tabView [activeIndex]="index" (onChange)="handleTabChange($event)">
        <p-tabPanel i18n-header="@@vistaSeleccionador" header="{{ selectedQueryMode != 'SQL' ? editQuery : editSQLQuery}}">
          @if (selectedQueryMode !== 'SQL') {
            <!-- Edit Query View -->
            <div class="flex h-full">
              <!-- Left Sidebar -->
              <div class="flex w-[500px] border-r">
                <!-- Entities Section -->
                <div class="w-1/2 border-r">
                  <div class="border-b p-3">
                    <h3 i18n="@@entidadesH4" class="text-lg mb-2 font-bold"
                      i18n-title="@@entidadesTitle" title="Clique sobre un entidad para ver sus atributos.">
                      Entidades
                    </h3>
                    <input class="h-8 w-full rounded-md border px-2" placeholder="Buscar entidades...">
                  </div>
                  <div class="h-full overflow-y-auto">
                    <ng-template #entityList>
                      <div class="space-y-1 p-2">
                        @for (entity of tablesToShow; track entity.table_name) {
                        <button class="flex w-full items-center justify-between rounded-md px-3 py-2"
                          [class.bg-[#00BFB3]]="userSelectedTable === entity.table_name"
                          [class.text-primary-foreground]="userSelectedTable === entity.table_name"
                          (click)="loadColumns(entity)"
                          (mouseover)="showDescription(entity)"
                          (mouseout)="description=''">
  
                          <span class="text-left font-bold" [title]="entity.description.default">
                            {{entity.display_name.default}}
                          </span>
                          <!-- <eda-icon name="chevron-right"></eda-icon> -->
                        </button>
                        }
                      </div>
                    </ng-template>
                    <!-- EDA STANDARD MODE -->
                    @if (selectedQueryMode=='EDA') {
                      <ng-container *ngTemplateOutlet="entityList"></ng-container>
                    }
                    <!-- EDA JOINS TREE MODE -->
                    @if (selectedQueryMode=='EDA2') {
                      @if (currentQuery.length > 0) {
                        <p-tree selectionMode="single"
                          [value]="tableNodes"
                          [loading]="loadingNodes"
                          (onNodeExpand)="tableNodeExpand($event)"
                          (onNodeSelect)="tableNodeSelect($event)">
                          <ng-template let-node pTemplate="child">
                            <span [ngClass]="checkNodeSelected(node) ? 'font-weight-bold' : ''"> {{node.label}} </span>
                          </ng-template>
                          <ng-template let-node pTemplate="default">
                            <b>{{node.label}}</b>
                          </ng-template>
                        </p-tree>
                      } @else {
                        <ng-container *ngTemplateOutlet="entityList"></ng-container>
                      }
                    }
                    <!-- ----------- -->
                  </div>
                </div>

                <!-- Attributes Section -->
                <div class="w-1/2">
                  <div class="border-b p-3">
                    <h3 class="text-lg mb-2 font-bold" i18n="@@atributosH4"
                      i18n-title="@@atributsTitle" title="Atributos de una entidad. Arrastre los atrubutos a la selección o los filtros para consultarlos. Haciendo click sobre el atributo se accede a sus propiedaes">
                      Atributos
                    </h3>
                    <input 
                      class="h-8 w-full rounded-md border px-2" 
                      placeholder="Buscar atributos..."
                    >
                  </div>
                  <div class="h-full overflow-y-auto">
                    <div 
                      class="space-y-1 p-2"
                      cdkDropList
                      #columnsList="cdkDropList"
                      [cdkDropListData]="columns"
                      [cdkDropListConnectedTo]="[selectList, filterList]"
                      (cdkDropListDropped)="drop($event)"
                      [cdkDropListEnterPredicate]="isAllowed"
                    >
                      @for (attr of columns; track attr.name) {
                        <div 
                          class="flex w-full items-center gap-2 rounded-md px-3 py-2  font-bold bg-background hover:bg-muted/50 cursor-move"
                          cdkDrag
                          [cdkDragData]="attr"
                          (cdkDragDropped)="searchRelations(attr)"
                          (click)="moveItem(attr)"
                          [style.opacity]="attr.hidden && attr.hidden == 1 ? '0.5' : '1'"
                        >
                          <span class="mdi {{getAttributeTypeIcon(attr.column_type)}}"></span>
                          {{attr.display_name.default}}
                          <i class="drag-handle-icon ml-auto"></i>
                          
                          <!-- Preview cuando se está arrastrando -->
                          <div *cdkDragPreview class="flex items-center gap-2 rounded-md px-3 py-2 bg-background border shadow-lg">
                            <span class="mdi {{getAttributeTypeIcon(attr.column_type)}}"></span>
                            {{attr.display_name.default}}
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              </div>

              <!-- Main Content Area -->
              <div class="flex-1 p-6">
                <div class="space-y-6">
                  <!-- Selected Attributes -->
                  <div>
                    <h3 i18n="@@seleccionH4" class="text-lg mb-2 font-bold"
                      i18n-title="@@seleccionTitle" title="Para lanzar una consulta. Seleccione los atributos que desea ver, Clique sobre ellos para configurarlos y ejecute la consulta. Siempre podrá volver a esta vista.">
                      Mostrar los siguientes atributos:
                    </h3>
                    <div 
                      class="flex gap-1 rounded-lg border p-2 min-h-[55px]"
                      cdkDropList
                      #selectList="cdkDropList"
                      cdkDropListOrientation="horizontal"
                      [cdkDropListConnectedTo]="[columnsList, filterList]"
                      (cdkDropListDropped)="drop($event)"
                    >
                      @for (attr of currentQuery; track attr) {
                        <div
                          class="flex justify-start items-center gap-2 rounded-md px-3 py-2 font-bold bg-muted/50 cursor-move min-w-[250px] z-10"
                          (click)="openColumnDialog(attr)"
                          (mouseover)="showDescription(attr)"
                          (mouseout)="description = ''"
                          [cdkDragData]="columns"
                          cdkDrag
                        >
                          <i class="drag-handle-icon"></i>
                          <span class="mdi {{getAttributeTypeIcon(attr.column_type)}}"></span>
                          <span [title]="attr.description.default">{{attr.display_name.default}}</span>
                          <button 
                            class="ml-auto rounded-full hover:bg-muted-foreground/20 z-50"
                            (click)="removeColumn(attr, 'select'); $event.stopPropagation()"
                          >
                            <i class="fa fa-close z-50 pointer-events-auto"></i>
                          </button>

                          <!-- Preview cuando se está arrastrando -->
                          <div *cdkDragPreview class="flex items-center gap-2 rounded-md px-3 py-2 bg-background border shadow-lg">
                            <span class="mdi {{getAttributeTypeIcon(attr.column_type)}}"></span>
                            {{attr.display_name.default}}
                          </div>
                        </div>
                      }

                      @if (currentQuery.length === 0) {
                        <div class=" text-muted-foreground text-center py-2">
                          {{draggFields}}
                        </div>
                      }
                    </div>
                  </div>

                  <!-- Filter section -->
                  <div>
                    <h3 class="text-lg mb-2 font-bold" i18n="@@filtrosH4">Filtrar los resultados por:</h3>
                    <div 
                      class="flex gap-1 rounded-lg border p-2 min-h-[55px]"
                      cdkDropList
                      #filterList="cdkDropList"
                      cdkDropListOrientation="horizontal"
                      [cdkDropListData]="filtredColumns"
                      [cdkDropListConnectedTo]="[columnsList, selectList]"
                      (cdkDropListDropped)="drop($event)"
                    >
                      @for (attr of filtredColumns; track attr.display_name.default) {
                        <div 
                          class="flex justify-start items-center gap-2 rounded-md px-3 py-2 font-bold bg-muted/50 cursor-move min-w-[250px]"
                          (click)="openColumnDialog(attr, true)"
                          (mouseover)="showDescription(attr)"
                          (mouseout)="description = ''"
                          [cdkDragData]="columns"
                          cdkDrag
                        >
                          <i class="drag-handle-icon"></i>
                          <span class="mdi {{getAttributeTypeIcon(attr.column_type)}}"></span>
                          {{attr.display_name.default}}
                          <button 
                            class="ml-auto rounded-full hover:bg-muted-foreground/20"
                            (click)="removeColumn(attr, 'filter')"
                            >
                            <i class="fa fa-close"></i>
                          </button>

                          <!-- Preview cuando se está arrastrando -->
                          <div *cdkDragPreview class="flex items-center gap-2 rounded-md px-3 py-2 bg-background border shadow-lg">
                            <span class="mdi {{getAttributeTypeIcon(attr.column_type)}}"></span>
                            {{attr.display_name.default}}
                          </div>
                        </div>
                      }

                      @if (filtredColumns.length === 0) {
                        <div class=" text-muted-foreground text-center py-2">
                          {{draggFilters}}
                        </div>
                      }
                    </div>
                  </div>
<!--              <p-selectButton [options]="joinTypeOptions" [(ngModel)]="joinType"  (onChange)="onJoinTypeChange()"  optionLabel="icon" optionValue="joinType" >
                      <ng-template let-item>
                          <i [class]="item.icon"></i>

                      </ng-template>
                  </p-selectButton> -->
                
                  <!-- Advanced Settings -->
                  <div class="mt-4 mb-2">
                    <h3 class="text-lg font-bold flex items-center">
                      Opciones avanzadas
                      <eda-icon [name]="display_v.advancedSetting ? 'chevron-up' : 'chevron-down'" class="cursor-pointer" (click)="display_v.advancedSetting = !display_v.advancedSetting"></eda-icon>
                    </h3>
                    
                    @if (display_v.advancedSetting) {
                      <div class="flex items-end gap-10 pl-2">
                        <!-- Join Type -->
                        <div>
                          <h3 class="text-base font-bold">-<span i18n="@@joinTypeH4">Tipo de intersección:</span></h3>
                          <div class="flex gap-2">
                            <button *ngFor="let type of joinTypeOptions" class="border px-3 py-1 rounded-lg hover:bg-gray-100" (click)="onJoinTypeChange(type)" >
                              {{ type.label }}
                            </button>
                          </div>
                        </div>
                        <!-- Show Top -->
                        <div>
                          <h3 class="text-base font-bold">-<span i18n="@@topQueryH4">Mostrar Top:</span></h3>
                          <input type="number" [(ngModel)]="queryLimit" class="w-full border p-1 rounded" (input)="onTopChange()">
                        </div>

                        <div>
                          <button class="border px-3 py-2 rounded-lg font-bold hover:bg-gray-100"
                            (click)="onWhatIfDialog()">
                            What If?
                          </button>
                        </div>
                      </div>
                    }
                  </div>

                  <!-- Query Summary -->
                  <div class="mt-4 border-t pt-4">
                    <div class="flex items-center justify-between">
                      <span class="flex items-center gap-1">
                        <h3 class="text-lg font-bold" i18n="@@yourQuerySQL">Mi consulta SQL</h3>
                          <i class="pi pi-info-circle cursor-pointer"
                            [pTooltip]="ptooltipViewQuery"
                            (click)="getQuery($event)">
                          </i>
                      </span>
                    </div>

                    <div class="grid grid-cols-2 mt-2 border rounded-lg bg-gray-50 p-4 min-h-[230px]">
                      <div>
                        <h3 class="text-base font-semibold" i18n="@@resumenAtrH6">Resumen de atributos</h3>
                      
                        @for (attr of currentQuery; track attr.display_name.default) {
                          <p class="flex items-center">
                            <strong [innerHTML]="getColumnJoins(attr)"></strong>
                            <span>
                              <strong> {{ getNiceTableName(attr.table_id) }} </strong>
                              <i class="pi pi-angle-right"></i>
                              {{attr.display_name.default}}
                            </span>
                            @for (aggregation of attr.aggregation_type; track aggregation.display_name) {
                              @if (aggregation.selected && !['No', 'no'].includes(aggregation.display_name)) {
                                &nbsp;({{aggregation.display_name}})
                              }
                            }
                          </p>
                        }
                        <br>
                        <h3 class="text-base font-semibold" i18n="@@resumenFiltrosPanelH6">Resumen de filtros del panel</h3>
                        @for (attr of selectedFilters; track attr) {
                          <p class="flex items-center">
                            <strong [innerHTML]="getFilterJoins(attr)"></strong>
                            <span [innerHTML]="getDisplayFilterStr(attr)">
                              <!-- <strong> {{ getNiceTableName(attr.table_id) }} </strong>
                              <i class="pi pi-angle-right"></i>
                              {{attr.display_name.default}} -->
                            </span>
                          </p>
                        }
                      </div>

                      <div>
                        <h3 class="text-base font-semibold" i18n="@@resumenFiltrosInformeH6">Resumen de filtros del informe</h3>
                        @for (attr of globalFilters; track attr) {
                          <p class="flex items-center">
                            <strong [innerHTML]="getFilterJoins(attr)"></strong>
                            <span [innerHTML]="getDisplayFilterStr(attr)">
                              <!-- <strong> {{ getNiceTableName(attr.table_id) }} </strong>
                              <i class="pi pi-angle-right"></i>
                              {{attr.display_name.default}} -->
                            </span>
                          </p>
                        }
                      </div>
                    </div>

                    <!-- 

                    <div class="col-12 md:col-6 pl-2">
                        <h5 i18n="@@resumenFiltrosInformeH6">
                            Resumen de filtros del informe
                        </h5>

                        <div *ngFor="let filter of globalFilters" class="d-flex align-items-center">
                            <strong class="d-flex align-items-center" [innerHTML]="getFilterJoins(filter)"></strong>

                            <span class="d-flex align-items-center" [innerHTML]="getDisplayFilterStr(filter)"></span>
                        </div>
                    </div> -->
                  </div>


<!--                                 <div class="col-12 md:col-12 info-query" *ngIf="currentQuery.length !== 0">
                                    <div #myQuery>
                                        <span i18n="@@consultaH4" class="span-title">
                                            Mi consulta
                                        </span>

                                        <span>
                                            <i class="pi pi-info-circle" style="cursor: pointer; margin-top: -5px;"
                                                (click)="getQuery($event)" [pTooltip]="ptooltipViewQuery"></i>
                                        </span>
                                    </div>

                                    <hr>

                                    <p-overlayPanel #op [appendTo]="'body'">
                                      <ng-template pTemplate>
                                          <div>
                                              <h6 i18n="@@yourQuerySQL">Mi consulta SQL</h6>
                                              <div *ngIf="display_v.minispinnerSQL"
                                                  style="text-align: center; margin: solid 1px grey;">

                                                  <p-progressSpinner *ngIf="display_v.minispinnerSQL"
                                                      [style]="{width: '4vw', height: '4vh'}" strokeWidth="5" class=""
                                                      fill="#EEEEEE" animationDuration=".5s">
                                                  </p-progressSpinner>

                                              </div>

                                              <textarea *ngIf="!display_v.minispinnerSQL" id="query-area" class="sqlInput"
                                                  rows="10" cols="100" pInputTextarea autoResize="autoResize"
                                                  [(ngModel)]="queryFromServer"></textarea>
                                          </div>
                                          <button type="button" pButton icon="fa fa-database" (click)="migrateQuery()"
                                              class="p-button-success ml-2" i18n-label="@@openSqlMode"
                                              label="Abrir en modo SQL" [pTooltip]="ptooltipSQLmode">
                                          </button>
                                      </ng-template>
                                  </p-overlayPanel>


                                  <div class="grid">

                                      <div class="col-12 md:col-6 pl-2">
                                          <h5 i18n="@@resumenAtrH6">
                                              Resumen de atributos
                                          </h5>

                                          <div *ngFor="let column of currentQuery" class="d-flex align-items-center">

                                              <strong class="d-flex align-items-center" [innerHTML]="getColumnJoins(column)"></strong>

                                              <span class="d-flex align-items-center">
                                                  <strong> {{ getNiceTableName(column.table_id) }} </strong>
                                                  <i class="pi pi-angle-right"></i>
                                                  {{column.display_name.default}}
                                              </span>

                                              <ng-container *ngFor="let aggregation of column.aggregation_type">
                                                  <span *ngIf="aggregation.selected && aggregation.display_name !== 'no'" class="d-flex align-items-center">
                                                      ( {{aggregation.display_name}} )
                                                  </span>
                                              </ng-container>

                                          </div>
                                      </div>


                                      <div class="col-12 md:col-6 pl-2">
                                          <h5 i18n="@@resumenFiltrosPanelH6">
                                              Resumen de filtros del panel
                                          </h5>



                                          <div *ngFor="let filter of selectedFilters" class="d-flex align-items-center">
                                              <strong class="d-flex align-items-center" [innerHTML]="getFilterJoins(filter)"></strong>

                                              <span class="d-flex align-items-center" [innerHTML]="getDisplayFilterStr(filter)"></span>
                                          </div>
                                      </div>

                                      <div class="col-12 md:col-6 pl-2">
                                          <h5 i18n="@@resumenFiltrosInformeH6">
                                              Resumen de filtros del informe
                                          </h5>

                                          <div *ngFor="let filter of globalFilters" class="d-flex align-items-center">
                                              <strong class="d-flex align-items-center" [innerHTML]="getFilterJoins(filter)"></strong>

                                              <span class="d-flex align-items-center" [innerHTML]="getDisplayFilterStr(filter)"></span>
                                          </div>
                                      </div>
                                  </div>
                              </div> -->

                </div>
              </div>
            </div>
          } @else {
            <!-- Edit SQL Query View -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-0 h-full">
              <div class="md:col-span-3 p-4 border-r border-gray-200">
                <div class="space-y-4">
                  <h3 class="font-semibold text-gray-700" i18n="@@sqlExpresionH6">Expresión SQL</h3>

                  <div class="relative">
                    <textarea 
                      [(ngModel)]="currentSQLQuery" 
                      class="w-full h-64 p-3 border border-gray-300 rounded-md font-mono text-sm resize-none focus:outline-none focus:ring-2 focus:ring-[#00BFB3] focus:border-[#00BFB3]"
                      placeholder="SELECT * FROM customers">
                    </textarea>
                    <button 
                      class="absolute right-2 top-2 px-2 py-1 text-sm border border-gray-300 rounded-md bg-white hover:bg-gray-100 flex items-center">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-500 mr-1">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                      </svg>
                      Sugerir
                    </button>
                  </div>
                </div>
              </div>
              <div class="md:col-span-2 border-t md:border-t-0 border-gray-200 overflow-y-auto">
                <div class="p-3">
                  <h3 class="font-semibold mb-4" i18n="@@indicaciones">Indicaciones</h3>


                  <div class="w-full">
                    <!-- General Information -->
                    <details class="group border-b border-gray-200" open>
                      <summary class="flex justify-between items-center cursor-pointer py-2 font-semibold">
                        <div class="flex items-center">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500 mr-2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                          </svg>
                          Información general
                        </div>
                        <svg class="h-5 w-5 text-gray-500 group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                      </summary>
                      <div class="text-sm text-gray-600 pl-2 pb-4 pt-2">
                        <!-- <p>Crea consultas SQL para analizar datos de ventas por línea de producto.</p>
                        <p class="mt-2">Tablas disponibles: Customers, Orders, Products, Employees, Offices.</p> -->
                        <p class="mb-2" i18n="@@indicaciones1"> Puedes realizar consultas SQL sobre el esquema definido
                          en tu modelo.
                          Para ello introduce la consulta en el cuadro de texto y selecciona la tabla
                          principal
                          (puede ser cualquiera de las que aparecen en la consulta).
                          Usaremos esta tabla para vincular la consulta a los filtros del informe.
                        </p>
                        
                        <h4 class="text-sm font-medium mb-2" i18n="@@indicaciones2">Limitaciones:</h4>

                        <ul class="list-disc pl-6">
                          <li i18n="@@indicaciones3">
                            Solo es posible usar las tablas del esquema definido en el modelo (si lo hay)
                          </li>
                          <li i18n="@@indicaciones4">
                            Debes utilizar alias para todas las tablas de la consulta ( select a,b from tabla t where c )
                          </li>
                        </ul>
                      </div>
                    </details>
        
                    <!-- Link query and panel filters -->
                    <details class="group border-b border-gray-200">
                      <summary class="flex justify-between items-center cursor-pointer py-2 font-semibold">
                        <div class="flex items-center">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500 mr-2">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                          </svg>
                          Vincular consulta y filtros del panel
                        </div>
                        <svg class="h-5 w-5 text-gray-500 group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                      </summary>
                      <div class="text-sm text-gray-600 pl-2 pb-4 pt-2">
                        <!-- <p>
                          Los filtros del panel se pueden vincular a tu consulta SQL para filtrar dinámicamente los
                          resultados.
                        </p>
                        <p class="mt-2">
                          Usa <code class="bg-gray-100 px-1 rounded">${city}</code> para referenciar el filtro de ciudad.
                        </p> -->
                        <p i18n="@@indicaciones5">
                          Puedes vincular los filtros del informe con la consulta
                        </p>
                        <ul class="list-disc pl-6">
                          <li i18n="@@indicaciones6">
                            Para hacerlo sólo tienes que añadir:
                            <span style="color:rgb(0, 62, 119); font-weight: bold"> AND
                                {{' ${alias_tabla.columna_filtrada} '}}
                            </span>
                            en la cláusula 'WHERE' de la consulta donde quieras inyectar el filtro
                          </li>
                          <li i18n="@@indicaciones7">
                            Si no has añadido ningúna cláusula WHERE, añádela a
                            la consulta y haz los joins necesarios,
                            junto con el filtro en el formato
                            <span style="color:rgb(0, 62, 119); font-weight: bold">
                              {{' ${alias_tabla.columna_filtrada} '}}
                            </span>
                          </li>
                          <li i18n="@@indicaciones8">
                            Si la tabla por la que filtramos no está en la consulta,
                            recuerda que debes añadir las cláusulas JOIN necesarias
                            para poder vicular la tabla del filtro con tu consulta
                          </li>
                        </ul>
                      </div>
                    </details>
        
                    <!-- Examples -->
                    <details class="group border-b border-gray-200">
                      <summary class="flex justify-between items-center cursor-pointer py-2 font-semibold">
                        <div class="flex items-center">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500 mr-2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                          </svg>
                          Ejemplos
                        </div>
                        <svg class="h-5 w-5 text-gray-500 group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                      </summary>
                      <div class="pb-4 pt-2">
                        <div class="max-h-[400px] overflow-y-auto pr-4">
                          <div class="space-y-4">
                            <!-- Simple Query -->
                            <div>
                              <h4 class="text-sm font-medium mb-2" i18n="@@indicaciones9">Consulta simple</h4>
                              <div class="bg-gray-50 p-3 rounded-md text-sm font-mono">
                                <div class="flex items-start">
                                  <div class="flex-1">SELECT c.customername FROM CUSTOMERS c</div>
                                </div>
                              </div>
                            </div>
        
                            <!-- Query with linked filters -->
                            <div>
                              <h4 class="text-sm font-medium mb-2" i18n="@@indicaciones10">Consulta con los filtros del informe vinculados</h4>
                              <p class="text-gray-500 mb-2" i18n="@@indicaciones11">
                                Tenemos un filtro en el reporte para el campo 'city' de la tabla CUSTOMERS
                              </p>

                              <p class="text-sm text-gray-500" i18n="@@indicaciones12"> Consulta sin filtros vinculados</p>
                              <div class="bg-gray-50 p-3 rounded-md text-sm font-mono">
                                <div class="flex items-start">
                                  <div class="flex-1">
                                    SELECT c.customername FROM CUSTOMERS c<br />
                                    WHERE c.customername IN ('Julia', 'John')
                                  </div>
                                </div>
                              </div>
                              <p class="text-sm text-gray-500 mt-2" i18n="@@indicaciones13">Consulta con filtros vinculados</p>
                              <div class="bg-gray-50 p-3 rounded-md text-sm font-mono">
                                <div class="flex items-start">
                                  <div class="flex-1">
                                    SELECT c.customername FROM CUSTOMERS c<br />
                                    WHERE c.customername IN ('Julia', 'John')<br />
                                    AND c.city = {{'${c.city}'}}
                                  </div>
                                </div>
                              </div>
                            </div>
        
                            <!-- Query with JOIN -->
                            <div>
                              <h4 class="text-sm font-medium mb-2">Consulta con JOIN</h4>
                              <div class="bg-gray-50 p-3 rounded-md text-sm font-mono">
                                <div class="flex items-start">
                                  <div class="flex-1">
                                    SELECT e.employee_name FROM EMPLOYEE e<br>
                                    INNER JOIN OFFICES o ON o.office_id = e.office_id<br>
                                    WHERE e.employee_name IN ('Julia', 'John')<br>
                                    AND o.office_id = {{'${o.office_id}'}}
                                  </div>
                                </div>
                              </div>
                            </div>
        
                            <!-- Query with aggregation -->
                            <div>
                              <h4 class="text-sm font-medium mb-2">Consulta con agregación</h4>
                              <div class="bg-gray-50 p-3 rounded-md text-sm font-mono">
                                <div class="flex items-start">
                                  <div class="flex-1">
                                    SELECT c.customername, COUNT(o.order_id) as total_orders,<br />
                                    SUM(o.amount) as total_amount<br />
                                    FROM CUSTOMERS c<br />
                                    JOIN ORDERS o ON c.customer_id = o.customer_id<br />
                                    GROUP BY c.customername<br />
                                    ORDER BY total_amount DESC
                                  </div>
                                  <!-- <button 
                                    class="h-6 w-6 p-0 ml-2 -mt-1 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded-md"
                                    (click)="copyQuery('SELECT c.customername, COUNT(o.order_id) as total_orders,\nSUM(o.amount) as total_amount\nFROM CUSTOMERS c\nJOIN ORDERS o ON c.customer_id = o.customer_id\nGROUP BY c.customername\nORDER BY total_amount DESC')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                  </button> -->
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </details>
                  </div>
                </div>
              </div>
            </div>
          }
        </p-tabPanel>
        <p-tabPanel i18n-header="@@vistaPrevia" header="VISTA PREVIA" [disabled]="display_v.disablePreview || currentQuery.length === 0">
          <!-- Preview View -->
          <div class="flex h-full max-h-[600px] gap-6 p-6">
            <div class="flex-1 rounded-lg border p-4 bg-muted/30">
                <!-- Preview Chart  -->
                <panel-chart
                  class="block h-full w-full"
                  #panelChartComponentPreview
                  [props]="panelChartConfig"
                ></panel-chart>
            </div>
            <div class="w-96 space-y-2" [ngClass]="{'w-3/6': graphicType==='crosstable'}">
              <form [formGroup]="chartForm">
                <p-dropdown
                  id="chartSelector"
                  formControlName="chart"
                  optionLabel="label"
                  [style]="{'width':'100%'}"
                  [options]="chartTypes"
                  [autoDisplayFirst]="false"
                  (onChange)="changeChartType(chartForm.value.chart.value, chartForm.value.chart.subValue, getChartStyles(chartForm.value.chart.value))"
                >
              
                  <ng-template pTemplate="selectedItem">
                    @if (chartForm.value.chart) {
                      <div class="flex items-center">
                        @if (!!chartForm.value.chart.ngIf) {
                          <i class="{{chartForm.value.chart.icon}} text-[#eeac57] items-center"></i>
                        }
                        <span class="material-icons">
                          {{getOptionIcon(chartForm.value.chart.subValue)}}
                        </span>
                        <span class="items-center ml-2">
                          {{chartForm.value.chart.label}}
                        </span>
                      </div>
                    }
                  </ng-template>
              
                  <ng-template let-chart pTemplate="item">
                    <div class="flex items-center relative h-6"
                      [attr.title]="chart.tooManyData ? getTooManyDataDescription() : (chart.ngIf) ? getOptionDescription(chart.subValue) : ''"
                    >
                      <span class="material-icons" [ngClass]="{'orange-alert': chart.ngIf, 'grey-alert': chart.tooManyData}">
                        {{getOptionIcon(chart.subValue)}}
                      </span>
              
                      <span class="ml-2" [ngClass]="{'texto-rallado-alert': chart.ngIf  || chart.tooManyData}">
                        {{chart.label}}
                      </span>
                      
                      @if (chart.tooManyData) {
                        <span i18n="@@tooManyValues" class="edaTooManyData">
                          - Demasiados valores
                        </span>
                      }
                      
                      @if (chart.ngIf) {
                        <span i18n="@@notAvaliable" class="edaTooManyData">
                          - No Disponible
                        </span>
                      }
                    </div>
                  </ng-template>
                </p-dropdown>
              </form>
              @if (dragAndDropAvailable && graphicType==='crosstable') {
                <drag-drop [axes]="axes" (newAxes)="newAxesOrdering($event)"></drag-drop>
              }
            </div>
          </div>
        </p-tabPanel>
      </p-tabView>
    </div>
  </div>

  <ng-container footer>
    <button
      class="rounded-md px-4 py-2 bg-gradient-to-r from-[#00B0BA] to-teal-400 text-white"
      [disabled]="disableRunQuery()"
      (click)="runManualQuery()">
      Execute
    </button>
    <button
      class="rounded-md px-4 py-2 border"
      (click)="closeEditarConsulta()">
      Cancel
    </button>
    <button
      class="rounded-md px-4 py-2 bg-primary text-primary-foreground"
      [disabled]="display_v.btnSave"
      (click)="savePanel()">
      Confirm
    </button>
  </ng-container>
</eda-dialog2>

<app-column-dialog *ngIf="configController" [controller]="configController"></app-column-dialog>

<app-filter-dialog *ngIf="filterController" [controller]="filterController"></app-filter-dialog>

<app-chart-dialog *ngIf="chartController" [controller]="chartController"></app-chart-dialog>

<app-mapedit-dialog *ngIf="mapController" [controller]="mapController"></app-mapedit-dialog>

<app-kpi-dialog *ngIf="kpiController" [controller]="kpiController"></app-kpi-dialog>

<app-dynamicText-dialog *ngIf="dynamicTextController" [controller]="dynamicTextController"></app-dynamicText-dialog>

<app-table-dialog *ngIf="tableController" [controller]="tableController"></app-table-dialog>

<app-alert-dialog *ngIf="alertController" [controller]="alertController"></app-alert-dialog>

<app-cumsum-alert-dialog *ngIf="cumsumAlertController" [controller]="cumsumAlertController"></app-cumsum-alert-dialog>

<app-sankey-dialog *ngIf="sankeyController" [controller]="sankeyController"></app-sankey-dialog>

<app-bubblechart-dialog *ngIf="bubblechartController" [controller]="bubblechartController"></app-bubblechart-dialog>

<app-tree-map-dialog *ngIf="treeMapController" [controller]="treeMapController"></app-tree-map-dialog>

<app-funnel-dialog *ngIf="funnelController" [controller]="funnelController"></app-funnel-dialog>

<app-scatter-plot-dialog *ngIf="scatterPlotController" [controller]="scatterPlotController"></app-scatter-plot-dialog>

<link-dashboards-dialog *ngIf="linkDashboardController" [controller]="linkDashboardController"></link-dashboards-dialog>

<knob-dialog *ngIf="knobController" [controller]="knobController"> </knob-dialog>

<sunburst-dialog *ngIf="sunburstController" [controller]="sunburstController"> </sunburst-dialog>

<eda-context-menu [inject]="contextMenu"></eda-context-menu>

<app-whatif-dialog *ngIf="display_v.whatIf_dialog" [(currentQuery)]="currentQuery" (close)="onCloseWhatIfDialog()"></app-whatif-dialog>
